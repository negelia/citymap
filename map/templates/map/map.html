<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞—Ä—Ç–∞ –¢—É–∞–ª–µ—Ç–æ–≤</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #map {
      height: 70vh;
      width: 100%;
    }
    .menu-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 30px;
      background-color: #faf3f3;
    }
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      background: #fffafc;
      margin-bottom: 10px;
    }
    .chat-message {
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .btn-pink {
      background-color: #e75480;
      color: white;
    }
    .btn-pink:hover {
      background-color: #d1436d;
    }
    .mapboxgl-popup-content {
      max-width: 300px !important;
    }
    .mapboxgl-popup img {
      max-width: 100%;
      max-height: 150px;
    }
    .map-controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
      background: white;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<div class="map-controls" style="right: 10px; left: auto;">
  <label for="roleSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</label>
  <select id="roleSelect" class="form-select">
    <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
    <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
  </select>
</div>

<div class="map-controls">
  <label for="filterSelect" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</label>
  <select id="filterSelect" class="form-select" onchange="filterMarkersByCategory()">
    <option value="all">–í—Å–µ</option>
    <option value="toilet">–°–∞–Ω—É–∑–µ–ª</option>
    <option value="water">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–æ–¥—ã</option>
    <option value="rest">–ó–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞</option>
  </select>
</div>

<div id="map"></div>

<div class="menu-buttons">
  <button class="btn btn-pink" onclick="enableAddMode()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
  <button class="btn btn-success" onclick="findNearby()">üìç –¢—É–∞–ª–µ—Ç—ã —Ä—è–¥–æ–º</button>
  <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#forumModal">üí¨ –§–æ—Ä—É–º</button>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="toiletForm">
        <div class="modal-header">
          <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—É–∞–ª–µ—Ç</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" class="form-control" id="toiletTitle" required>
          </div>
          <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea class="form-control" id="toiletDescription" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">–§–æ—Ç–æ</label>
            <input type="file" class="form-control" id="toiletPhoto" accept="image/*">
          </div>
          <div class="mb-3">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select class="form-select" id="toiletCategory" required>
              <option value="toilet">–°–∞–Ω—É–∑–µ–ª</option>
              <option value="water">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–æ–¥—ã</option>
              <option value="rest">–ó–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞</option>
            </select>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="moderationCheckbox">
            <label class="form-check-label" for="moderationCheckbox">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º</label>
          </div>
          <div class="mb-3">
            <label class="form-label">–†–µ–π—Ç–∏–Ω–≥ (1-5)</label>
            <input type="number" class="form-control" id="toiletRating" min="1" max="5" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-pink">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="forumModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–§–æ—Ä—É–º —Ç—É–∞–ª–µ—Ç–æ–≤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control mb-2" id="usernameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
        <div class="chat-messages" id="chatMessages"></div>
        <form id="chatForm" class="d-flex mt-2">
          <input type="text" class="form-control me-2" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" required>
          <button type="submit" class="btn btn-pink">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="rewardModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content text-center p-4">
      <h5 class="modal-title" id="rewardText">üéâ</h5>
      <button type="button" class="btn btn-success mt-3" data-bs-dismiss="modal">–ö—Ä—É—Ç–æ!</button>
    </div>
  </div>
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoibmVnZWxpYSIsImEiOiJjbTlia3dtajkwYnYwMmxzYXhwc2kweHI0In0.DJ_UuwkqthuDDjY2HUQpRg'; 
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [37.618423, 55.751244],
    zoom: 12
  });

  let addMode = false;
  let clickedLngLat = null;
  let toiletMarkers = [];
  let toiletCount = JSON.parse(localStorage.getItem("toiletCount") || "0");
  let backendMarkers = JSON.parse(localStorage.getItem("backendMarkers") || "[]");

  map.on('load', () => {
    loadModeratedMarkers();
  });

  function enableAddMode() {
    addMode = true;
    alert("–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É.");
  }

  map.on('click', (e) => {
    if (addMode) {
      clickedLngLat = e.lngLat;
      const modal = new bootstrap.Modal(document.getElementById('addModal'));
      modal.show();
    }
  });

  function addMarker({id, lng, lat, title, description, photo, rating, category, moderated}) {
    let photoHtml = '';
    if (photo) {
      if (photo.startsWith('data:') || photo.startsWith('http')) {
        photoHtml = `<br><img src="${photo}" style="max-width:100%;">`;
      } else {
        photoHtml = `<br><img src="/media/${photo}" style="max-width:100%;">`;
      }
    }
  
    const popup = new mapboxgl.Popup()
      .setHTML(`
        <b>${title}</b><br>
        ${description}<br>
        –†–µ–π—Ç–∏–Ω–≥: ${rating}/5<br>
        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCategoryName(category)}
        ${photoHtml}
      `);
  
    const marker = new mapboxgl.Marker({
      color: getCategoryColor(category)
    })
      .setLngLat([lng, lat])
      .setPopup(popup)
      .addTo(map);
    
    marker.id = id;
    marker.category = category;
    marker.moderated = moderated;
    toiletMarkers.push(marker);
  }

  function getCategoryName(category) {
    return {
      'toilet': '–°–∞–Ω—É–∑–µ–ª',
      'water': '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–æ–¥—ã',
      'rest': '–ó–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞'
    }[category] || category;
  }

  function getCategoryColor(category) {
    return {
      'toilet': '#e75480',
      'water': '#4287f5',
      'rest': '#42f551'
    }[category] || '#000000';
  }

  function filterMarkersByCategory() {
    const selected = document.getElementById("filterSelect").value;
    toiletMarkers.forEach(marker => {
      if (selected === "all" || marker.category === selected) {
        marker.addTo(map);
      } else {
        marker.remove();
      }
    });
  }

  async function loadModeratedMarkers() {
    try {
      const response = await fetch('/api/markers/');
      if (response.ok) {
        backendMarkers = await response.json();
        backendMarkers.forEach(markerData => addMarker(markerData));
        
        const localMarkers = JSON.parse(localStorage.getItem("backendMarkers") || "[]");
        localMarkers.forEach(markerData => {
          if (!backendMarkers.some(m => m.id === markerData.id)) {
            addMarker(markerData);
          }
        });
        return;
      }
    } catch (error) {
      console.error("Error loading markers from backend:", error);
    }
    
    backendMarkers = JSON.parse(localStorage.getItem("backendMarkers") || "[]");
    backendMarkers
      .filter(m => m.moderated)
      .forEach(markerData => addMarker(markerData));
  }

  async function saveToBackend(markerData) {
    try {
        const formData = new FormData();
        formData.append('lng', markerData.lng);
        formData.append('lat', markerData.lat);
        formData.append('title', markerData.title);
        formData.append('description', markerData.description || '');
        formData.append('rating', markerData.rating);
        formData.append('category', markerData.category);
        formData.append('moderated', markerData.moderated);
        
        if (markerData.photo && markerData.photo.startsWith('data:')) {
            const blob = await fetch(markerData.photo).then(r => r.blob());
            formData.append('photo', blob, 'photo.jpg');
        }

        const response = await fetch('/api/markers/add/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        if (!response.ok) throw new Error('Network response was not ok');
        
        return await response.json();
    } catch (error) {
        console.error('Error saving marker:', error);
        return {
            status: 'error',
            message: error.message
        };
    }
}

  function isModerator() {
    return document.getElementById("roleSelect").value === "moderator";
  }

  document.getElementById("toiletForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    
    const title = document.getElementById("toiletTitle").value.trim();
    const description = document.getElementById("toiletDescription").value.trim();
    const rating = +document.getElementById("toiletRating").value;
    const category = document.getElementById("toiletCategory").value;
    const moderated = isModerator() && document.getElementById("moderationCheckbox").checked;
    const photoInput = document.getElementById("toiletPhoto");
    
    if (!title || !rating || !category) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
        return;
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–∞
    const markerData = { 
        id: Date.now(), // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        lng: clickedLngLat.lng, 
        lat: clickedLngLat.lat, 
        title, 
        description, 
        rating, 
        category, 
        moderated,
        photo: null
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ
    if (photoInput.files[0]) {
        markerData.photo = await convertImageToBase64(photoInput.files[0]);
    }

    try {
        // –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        const result = await saveToBackend(markerData);
        
        if (result.status === 'success') {
            // –ï—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ - –¥–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä
            addMarker(markerData);
            backendMarkers.push(markerData);
            localStorage.setItem("backendMarkers", JSON.stringify(backendMarkers));
            
            // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
            clickedLngLat = null;
            addMode = false;
            e.target.reset();
            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();

            // –ù–∞–≥—Ä–∞–¥—ã
            toiletCount++;
            localStorage.setItem("toiletCount", toiletCount);
            checkRewards();
        } else {
            throw new Error(result.message || 'Unknown error');
        }
    } catch (error) {
        console.error('Error saving to backend:', error);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
        markerData.moderated = false; // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –Ω–µ–º–æ–¥–µ—Ä–∏—Ä—É–µ–º–æ–µ
        addMarker(markerData);
        backendMarkers.push(markerData);
        localStorage.setItem("backendMarkers", JSON.stringify(backendMarkers));
        
        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
        clickedLngLat = null;
        addMode = false;
        e.target.reset();
        bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
        
        alert("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –¢–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ.");
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ base64
function convertImageToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

  function findNearby() {
    if (!navigator.geolocation) return alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.");
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude: lat, longitude: lng } = pos.coords;
      map.flyTo({ center: [lng, lat], zoom: 15 });
      
      if (map.getSource('user-location')) {
        map.getSource('user-location').setData({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [lng, lat]
          }
        });
      } else {
        map.addSource('user-location', {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [lng, lat]
            }
          }
        });
        
        map.addLayer({
          id: 'user-location-circle',
          type: 'circle',
          source: 'user-location',
          paint: {
            'circle-radius': 300,
            'circle-color': '#4287f5',
            'circle-opacity': 0.2,
            'circle-stroke-width': 2,
            'circle-stroke-color': '#4287f5'
          }
        });
      }
    });
  }

  const chatForm = document.getElementById("chatForm");
  const chatMessages = document.getElementById("chatMessages");
  const chatInput = document.getElementById("chatInput");
  const usernameInput = document.getElementById("usernameInput");

  const storedMessages = JSON.parse(localStorage.getItem("chatMessages")) || [];
  storedMessages.forEach(({ name, message }) => addChatMessage(name, message));

  chatForm.addEventListener("submit", function(e) {
    e.preventDefault();
    const name = usernameInput.value.trim() || "–ê–Ω–æ–Ω–∏–º";
    const message = chatInput.value.trim();
    if (message) {
      addChatMessage(name, message);
      saveChatMessage(name, message);
      chatInput.value = "";
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
  });

  function addChatMessage(name, message) {
    const msgEl = document.createElement("div");
    msgEl.className = "chat-message";
    msgEl.style.backgroundColor = stringToColor(name);
    msgEl.innerHTML = `<span>${name}:</span> ${message} `;
    chatMessages.appendChild(msgEl);
  }

  function saveChatMessage(name, message) {
    const saved = JSON.parse(localStorage.getItem("chatMessages")) || [];
    saved.push({ name, message });
    localStorage.setItem("chatMessages", JSON.stringify(saved));
  }

  function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    const color = Math.floor(Math.abs(Math.sin(hash) * 16777215)).toString(16);
    return "#" + "000000".substring(0, 6 - color.length) + color;
  }

  function checkRewards() {
    const rewardText = document.getElementById("rewardText");
    const rewardModal = new bootstrap.Modal(document.getElementById("rewardModal"));
    if (toiletCount === 3) {
      rewardText.innerText = "üöΩ –ë–∏–º–±–æ–¢—É–∞–ª–µ—Ç!";
      rewardModal.show();
    } else if (toiletCount === 5) {
      rewardText.innerText = "üï∫ –¢–£–ê–õ–ï–¢–ù–´–ô –ú–ê–ß–û!";
      rewardModal.show();
    } else if (toiletCount === 7) {
      rewardText.innerText = "üëë –ö–æ—Ä–æ–ª—å –£–Ω–∏—Ç–∞–∑–æ–≤!";
      rewardModal.show();
    } else if (toiletCount === 10) {
      rewardText.innerText = "üåà –õ–µ–≥–µ–Ω–¥–∞ –û—á–∫–∞!";
      rewardModal.show();
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
</body>
</html>