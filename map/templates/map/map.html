<!DOCTYPE html>
{% load static %}
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Toilet, Water & Relax</title>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–æ–≤ -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Inter:wght@400;600&family=JetBrains+Mono&display=swap');
  </style>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Mapbox -->
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />

  <!-- –°—Ç–∏–ª–∏ -->
  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    :root {
      --pink: #FF4A98;
      --dark-pink: #e75480;
      --darker-pink: #d1436d;
      --black: #000;
      --white: #fff;
      --light-gray: #f0f0f0;
      --gray: #ccc;
      --dark-gray: #888;
      --water-blue: #4287f5;
      --rest-green: #42f551;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      font-family: 'Bricolage Grotesque', 'Inter', sans-serif;
      background-color: var(--white);
      color: var(--black);
    }

    /* –°—Ç–∏–ª–∏ —à–∞–ø–∫–∏ */
    header {
      width: 100%;
      padding: 10px 20px;
      text-align: center;
      font-size: 70px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
    }

    .highlight {
      font-family: 'Bricolage Grotesque', sans-serif;
      font-weight: 500;
      font-size: 250px;
      color: var(--pink);
      line-height: 0.8;
      margin-top: 0;
      margin-left: 10px;
    }

    /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç—ã */
    #map {
      width: 100%;
      height: 70vh;
      background-color: var(--dark-gray);
      margin: 20px 0;
    }

    .mapboxgl-popup-content {
      max-width: 300px !important;
    }

    .mapboxgl-popup img {
      max-width: 100%;
      max-height: 150px;
    }

    .map-controls {
      position: absolute;
      top: 10px;
      z-index: 1;
      background: var(--white);
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }

    .map-controls.left {
      left: 10px;
    }

    .map-controls.right {
      right: 10px;
    }

    /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ */
    .menu-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 20px;
      justify-content: center;
      padding: 30px;
      margin-bottom: 40px;
      width: 100%;
      max-width: 1200px;
    }

    .btn-pink {
      background-color: var(--dark-pink);
      color: var(--white);
      border: none;
    }

    .btn-pink:hover {
      background-color: var(--darker-pink);
      color: var(--white);
    }

    /* –°—Ç–∏–ª–∏ —á–∞—Ç–∞ */
    .chat-messages {
      height: 300px;
      overflow-y: auto;
      border: 1px solid var(--gray);
      padding: 10px;
      background: #fffafc;
      margin-bottom: 10px;
    }

    .chat-message {
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 6px;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    @media (max-width: 600px) {
      header {
        font-size: 36px;
      }
      
      .highlight {
        font-size: 150px;
      }
      
      #map {
        height: 250px;
      }
      
      .menu-buttons {
        padding: 15px;
      }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–∫–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ */
    .auth-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    
    .auth-box {
      width: 320px;
      padding: 30px;
      border: 1px solid var(--gray);
      border-radius: 15px;
      text-align: center;
      background: var(--white);
      font-family: 'Inter', sans-serif;
    }
    
    .auth-box h1 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    .tabs {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .tab {
      flex: 1;
      padding: 10px;
      background: var(--light-gray);
      border: none;
      cursor: pointer;
      border-radius: 10px;
      font-weight: 600;
    }
    
    .tab.active {
      background: var(--black);
      color: var(--white);
    }
    
    .form input {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--gray);
      border-radius: 8px;
    }
    
    .form button {
      width: 100%;
      padding: 10px;
      background: var(--black);
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .forgot {
      font-size: 12px;
      color: var(--dark-gray);
      display: block;
      margin-bottom: 10px;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <!-- –û–∫–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω) -->
  {% if not user.is_authenticated %}
  <div id="authModal" class="auth-container">
    <div class="auth-box">
      <h1>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
      <div class="tabs">
        <button class="tab active" onclick="switchAuthTab('login')">–í—Ö–æ–¥</button>
        <button class="tab" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      <div class="form" id="loginForm">
        <input type="text" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
      </div>
      <div class="form hidden" id="registerForm">
        <input type="text" placeholder="–ò–º—è">
        <input type="email" placeholder="Email">
        <input type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      <span class="forgot">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</span>
    </div>
  </div>
  {% endif %}

  <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
  <div id="mainContainer">
    <header>
      Toilet, Water & Relax <span class="highlight">*</span>
    </header>

    <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ–π -->
    <div class="map-controls left">
      <label for="filterSelect" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:</label>
      <select id="filterSelect" class="form-select" onchange="filterMarkersByCategory()">
        <option value="all">–í—Å–µ</option>
        <option value="toilet">–°–∞–Ω—É–∑–µ–ª</option>
        <option value="water">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–æ–¥—ã</option>
        <option value="rest">–ó–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞</option>
      </select>
    </div>

    {% if user.is_authenticated %}
    <div class="map-controls right">
      <label for="roleSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</label>
      <select id="roleSelect" class="form-select">
        <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
        <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
      </select>

      <div class="mt-2">
        <a href="{% url 'logout' %}" class="btn btn-danger btn-sm">–í—ã–π—Ç–∏</a>
      </div>
    </div>
    {% endif %}

    <!-- –ö–∞—Ä—Ç–∞ -->
    <div id="map"></div>

    <!-- –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é -->
    <div class="menu-buttons">
      <button class="btn btn-pink" onclick="enableAddMode()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</button>
      <button class="btn btn-success" onclick="findNearby()">üìç –¢—É–∞–ª–µ—Ç—ã —Ä—è–¥–æ–º</button>
      <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#forumModal">üí¨ –§–æ—Ä—É–º</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ Bootstrap -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="toiletForm">
          <div class="modal-header">
            <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—É–∞–ª–µ—Ç</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" class="form-control" id="toiletTitle" required>
            </div>
            <div class="mb-3">
              <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
              <textarea class="form-control" id="toiletDescription" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">–§–æ—Ç–æ</label>
              <input type="file" class="form-control" id="toiletPhoto" accept="image/*">
            </div>
            <div class="mb-3">
              <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
              <select class="form-select" id="toiletCategory" required>
                <option value="toilet">–°–∞–Ω—É–∑–µ–ª</option>
                <option value="water">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–æ–¥—ã</option>
                <option value="rest">–ó–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞</option>
              </select>
            </div>
            {% if user.is_authenticated and user.is_staff %}
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="moderationCheckbox">
              <label class="form-check-label" for="moderationCheckbox">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º</label>
            </div>
            {% endif %}
            <div class="mb-3">
              <label class="form-label">–†–µ–π—Ç–∏–Ω–≥ (1-5)</label>
              <input type="number" class="form-control" id="toiletRating" min="1" max="5" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-pink">–î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="forumModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–§–æ—Ä—É–º —Ç—É–∞–ª–µ—Ç–æ–≤</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" class="form-control mb-2" id="usernameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
          <div class="chat-messages" id="chatMessages"></div>
          <form id="chatForm" class="d-flex mt-2">
            <input type="text" class="form-control me-2" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" required>
            <button type="submit" class="btn btn-pink">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="rewardModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content text-center p-4">
        <h5 class="modal-title" id="rewardText">üéâ</h5>
        <button type="button" class="btn btn-success mt-3" data-bs-dismiss="modal">–ö—Ä—É—Ç–æ!</button>
      </div>
    </div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    mapboxgl.accessToken = 'pk.eyJ1IjoibmVnZWxpYSIsImEiOiJjbTlia3dtajkwYnYwMmxzYXhwc2kweHI0In0.DJ_UuwkqthuDDjY2HUQpRg'; 
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [37.618423, 55.751244],
      zoom: 12
    });

    let addMode = false;
    let clickedLngLat = null;
    let toiletMarkers = [];
    let toiletCount = JSON.parse(localStorage.getItem("toiletCount") || "0");
    let backendMarkers = JSON.parse(localStorage.getItem("backendMarkers") || "[]");

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
    function switchAuthTab(tab) {
      if (tab === 'login') {
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('registerForm').classList.add('hidden');
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.querySelectorAll('.tab')[1].classList.remove('active');
      } else {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('registerForm').classList.remove('hidden');
        document.querySelectorAll('.tab')[0].classList.remove('active');
        document.querySelectorAll('.tab')[1].classList.add('active');
      }
    }
    
    function login() {
      alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
      hideAuthModal();
    }
    
    function register() {
      alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
      hideAuthModal();
    }
    
    function hideAuthModal() {
      document.getElementById('authModal').classList.add('hidden');
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–æ–π
    map.on('load', () => {
      loadModeratedMarkers();
    });

    function enableAddMode() {
      addMode = true;
      alert("–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É.");
    }

    map.on('click', (e) => {
      if (addMode) {
        clickedLngLat = e.lngLat;
        const modal = new bootstrap.Modal(document.getElementById('addModal'));
        modal.show();
      }
    });

    function addMarker({id, lng, lat, title, description, photo, rating, category, moderated}) {
      let photoHtml = '';
      if (photo) {
        if (photo.startsWith('data:') || photo.startsWith('http')) {
          photoHtml = `<br><img src="${photo}" style="max-width:100%;">`;
        } else {
          photoHtml = `<br><img src="/media/${photo}" style="max-width:100%;">`;
        }
      }
    
      const popup = new mapboxgl.Popup()
        .setHTML(`
          <b>${title}</b><br>
          ${description}<br>
          –†–µ–π—Ç–∏–Ω–≥: ${rating}/5<br>
          –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${getCategoryName(category)}
          ${photoHtml}
        `);
    
      const marker = new mapboxgl.Marker({
        color: getCategoryColor(category)
      })
        .setLngLat([lng, lat])
        .setPopup(popup)
        .addTo(map);
      
      marker.id = id;
      marker.category = category;
      marker.moderated = moderated;
      toiletMarkers.push(marker);
    }

    function getCategoryName(category) {
      return {
        'toilet': '–°–∞–Ω—É–∑–µ–ª',
        'water': '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–æ–¥—ã',
        'rest': '–ó–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞'
      }[category] || category;
    }

    function getCategoryColor(category) {
      return {
        'toilet': 'var(--pink)',
        'water': 'var(--water-blue)',
        'rest': 'var(--rest-green)'
      }[category] || '#000000';
    }

    function filterMarkersByCategory() {
      const selected = document.getElementById("filterSelect").value;
      toiletMarkers.forEach(marker => {
        if (selected === "all" || marker.category === selected) {
          marker.addTo(map);
        } else {
          marker.remove();
        }
      });
    }

    async function loadModeratedMarkers() {
      try {
        const response = await fetch('/api/markers/');
        if (response.ok) {
          backendMarkers = await response.json();
          backendMarkers.forEach(markerData => addMarker(markerData));
          
          const localMarkers = JSON.parse(localStorage.getItem("backendMarkers") || "[]");
          localMarkers.forEach(markerData => {
            if (!backendMarkers.some(m => m.id === markerData.id)) {
              addMarker(markerData);
            }
          });
          return;
        }
      } catch (error) {
        console.error("Error loading markers from backend:", error);
      }
      
      backendMarkers = JSON.parse(localStorage.getItem("backendMarkers") || "[]");
      backendMarkers
        .filter(m => m.moderated)
        .forEach(markerData => addMarker(markerData));
    }

    async function saveToBackend(markerData) {
      try {
          const formData = new FormData();
          formData.append('lng', markerData.lng);
          formData.append('lat', markerData.lat);
          formData.append('title', markerData.title);
          formData.append('description', markerData.description || '');
          formData.append('rating', markerData.rating);
          formData.append('category', markerData.category);
          formData.append('moderated', markerData.moderated);
          
          if (markerData.photo && markerData.photo.startsWith('data:')) {
              const blob = await fetch(markerData.photo).then(r => r.blob());
              formData.append('photo', blob, 'photo.jpg');
          }

          const response = await fetch('/api/markers/add/', {
              method: 'POST',
              body: formData,
              headers: {
                  'X-CSRFToken': getCookie('csrftoken')
              }
          });

          if (!response.ok) throw new Error('Network response was not ok');
          
          return await response.json();
      } catch (error) {
          console.error('Error saving marker:', error);
          return {
              status: 'error',
              message: error.message
          };
      }
    }

    function isModerator() {
      return document.getElementById("roleSelect").value === "moderator";
    }

    document.getElementById("toiletForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      
      const title = document.getElementById("toiletTitle").value.trim();
      const description = document.getElementById("toiletDescription").value.trim();
      const rating = +document.getElementById("toiletRating").value;
      const category = document.getElementById("toiletCategory").value;
      const moderated = isModerator() && document.getElementById("moderationCheckbox").checked;
      const photoInput = document.getElementById("toiletPhoto");
      
      if (!title || !rating || !category) {
          alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è.");
          return;
      }

      const markerData = { 
          id: Date.now(),
          lng: clickedLngLat.lng, 
          lat: clickedLngLat.lat, 
          title, 
          description, 
          rating, 
          category, 
          moderated,
          photo: null
      };

      if (photoInput.files[0]) {
          markerData.photo = await convertImageToBase64(photoInput.files[0]);
      }

      try {
          const result = await saveToBackend(markerData);
          
          if (result.status === 'success') {
              addMarker(markerData);
              backendMarkers.push(markerData);
              localStorage.setItem("backendMarkers", JSON.stringify(backendMarkers));
              
              clickedLngLat = null;
              addMode = false;
              e.target.reset();
              bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();

              toiletCount++;
              localStorage.setItem("toiletCount", toiletCount);
              checkRewards();
          } else {
              throw new Error(result.message || 'Unknown error');
          }
      } catch (error) {
          console.error('Error saving to backend:', error);
          markerData.moderated = false;
          addMarker(markerData);
          backendMarkers.push(markerData);
          localStorage.setItem("backendMarkers", JSON.stringify(backendMarkers));
          
          clickedLngLat = null;
          addMode = false;
          e.target.reset();
          bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
          
          alert("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –¢–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ.");
      }
    });

    function convertImageToBase64(file) {
      return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
          reader.readAsDataURL(file);
      });
    }

    function findNearby() {
      if (!navigator.geolocation) return alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.");
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude: lat, longitude: lng } = pos.coords;
        map.flyTo({ center: [lng, lat], zoom: 15 });
        
        if (map.getSource('user-location')) {
          map.getSource('user-location').setData({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: [lng, lat]
            }
          });
        } else {
          map.addSource('user-location', {
            type: 'geojson',
            data: {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [lng, lat]
              }
            }
          });
          
          map.addLayer({
            id: 'user-location-circle',
            type: 'circle',
            source: 'user-location',
            paint: {
              'circle-radius': 300,
              'circle-color': 'var(--water-blue)',
              'circle-opacity': 0.2,
              'circle-stroke-width': 2,
              'circle-stroke-color': 'var(--water-blue)'
            }
          });
        }
      });
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç–æ–º
    const chatForm = document.getElementById("chatForm");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const usernameInput = document.getElementById("usernameInput");

    const storedMessages = JSON.parse(localStorage.getItem("chatMessages")) || [];
    storedMessages.forEach(({ name, message }) => addChatMessage(name, message));

    chatForm.addEventListener("submit", function(e) {
      e.preventDefault();
      const name = usernameInput.value.trim() || "–ê–Ω–æ–Ω–∏–º";
      const message = chatInput.value.trim();
      if (message) {
        addChatMessage(name, message);
        saveChatMessage(name, message);
        chatInput.value = "";
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    });

    function addChatMessage(name, message) {
      const msgEl = document.createElement("div");
      msgEl.className = "chat-message";
      msgEl.style.backgroundColor = stringToColor(name);
      msgEl.innerHTML = `<span>${name}:</span> ${message} `;
      chatMessages.appendChild(msgEl);
    }

    function saveChatMessage(name, message) {
      const saved = JSON.parse(localStorage.getItem("chatMessages")) || [];
      saved.push({ name, message });
      localStorage.setItem("chatMessages", JSON.stringify(saved));
    }

    function stringToColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
      const color = Math.floor(Math.abs(Math.sin(hash) * 16777215)).toString(16);
      return "#" + "000000".substring(0, 6 - color.length) + color;
    }

    // –°–∏—Å—Ç–µ–º–∞ –Ω–∞–≥—Ä–∞–¥
    function checkRewards() {
      const rewardText = document.getElementById("rewardText");
      const rewardModal = new bootstrap.Modal(document.getElementById("rewardModal"));
      if (toiletCount === 3) {
        rewardText.innerText = "üöΩ –ë–∏–º–±–æ–¢—É–∞–ª–µ—Ç!";
        rewardModal.show();
      } else if (toiletCount === 5) {
        rewardText.innerText = "üï∫ –¢–£–ê–õ–ï–¢–ù–´–ô –ú–ê–ß–û!";
        rewardModal.show();
      } else if (toiletCount === 7) {
        rewardText.innerText = "üëë –ö–æ—Ä–æ–ª—å –£–Ω–∏—Ç–∞–∑–æ–≤!";
        rewardModal.show();
      } else if (toiletCount === 10) {
        rewardText.innerText = "üåà –õ–µ–≥–µ–Ω–¥–∞ –û—á–∫–∞!";
        rewardModal.show();
      }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }
  </script>
</body>
</html>